---
title: "MPIDR/INED COVID-19 cases and deaths by age and sex"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  word_document:
    toc: FALSE
always_allow_html: true
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message=FALSE, fig.width=8, fig.height=6)
```
 
```{r}
invisible(lapply(list.files(here::here("R"), full.names = TRUE), source))
suppressPackageStartupMessages({
  library("data.table")
  library("ggplot2")
  library("readr")
  library("cowplot")
  library("osfr")
})
WorldRobinson <- readRDS(here::here("data/NEWorldRobinson.rds"))
dtJHU <- get.JHU.daily()
dt5_ori <- download_covid(data = "Output_5", temp = TRUE, 
                          verbose = FALSE, progress = FALSE, return = "data.table") 
dt5 <- clean_outputDB(dt5_ori)
```

```{r}
all_countries <- get_cnames(dt5)
dt5_sex_1 <- pool_sex(dt5)
dt5_sex_2 <- pool_sex(dt5, sex_specific = TRUE)
dt5_sex <- rbindlist(list(dt5_sex_1, dt5_sex_2), use.names = TRUE)
# adjust country names now:
cnames_new <- revise_map_name(get_cnames(dt5_sex))
dt5_sex$Country_new <- revise_map_name(dt5_sex$Country)
dt5_sex[, N:= uniqueN(Country_new), by = .(Measure, Sex)]

# dt10 <- pool_age(dt5_sex, target_interval = seq(0, 100, by = 10))
dt_sum <- dt5_sex[, .(MPIDR = sum(Value)), by = .(Measure, Sex, N, Age)]
dt_sum_w <- dcast.data.table(dt_sum, Measure + Sex +N ~ Age, value.var = "MPIDR")
dt_sum_w[, MPIDR:= rowSums(.SD), .SDcols = as.character(seq(0, 100, 5))]
dt_sum_w[, Sum0_19:= rowSums(.SD), .SDcols = as.character(seq(0, 15, 5))]
dt_sum_w[, Pcnt := round(Sum0_19/MPIDR*100, 1)]
dt_sum_w[Measure == "Cases", `Age 0-19` := paste0(prettyNum(Sum0_19, big.mark = ","),
                                                 " (", round(Pcnt), "%)")]
dt_sum_w[Measure == "Deaths", `Age 0-19` := paste0(prettyNum(Sum0_19, big.mark = ","),
" (", Pcnt, "%)")]

dt_sum_w[Measure=="Cases" & Sex=="Both", `JHU`:=sum(dtJHU$Confirmed, na.rm = TRUE)]
dt_sum_w[Measure=="Deaths" & Sex=="Both", `JHU`:=sum(dtJHU$Deaths, na.rm = TRUE)]
dt_sum_w[!is.na(JHU), `COVerAGE-DB/JHU(%)`:= paste0(round(`MPIDR`/`JHU`*100), "%")]
dt_sum_w[!is.na(JHU), `COVerAGE-DB/JHU(%)`:= paste0(round(`MPIDR`/`JHU`*100), "%")]
setnames(dt_sum_w, as.character(seq(0, 15, 5)), paste("Age", c("0-4", "5-9", "10-14", "15-19")))
vars_wanted <- c("Measure", "Sex", "JHU", "MPIDR", "COVerAGE-DB/JHU(%)", paste("Age", c("0-4", "5-9", "10-14", "15-19", "0-19")))
dtt <- dt_sum_w[,..vars_wanted]
# Table Cases
cols1 <- c("JHU", "MPIDR", paste("Age", c("0-4", "5-9", "10-14", "15-19")))
dtt[, (cols1) := lapply(.SD, prettyNum, big.mark = ","), .SDcols = cols1]
dtt[JHU=="NA", JHU:=""]
dtt[Sex=="Both", Sex := "Total"]
# setnames(dtt, "N", "MPIDR Number\nof Countries")
setnames(dtt, paste("Age", c("0-4", "5-9", "10-14", "15-19", "0-19")), paste("Age\n", c("0-4", "5-9", "10-14", "15-19", "0-19")))
setnames(dtt, "MPIDR", "COVerAGE-DB")

# table to print
dt1 <- dtt[Sex=="Total"][,Sex:=NULL]
dt2 <- dtt[Sex!="Total"][, `COVerAGE-DB/JHU(%)`:=NULL]

# countries with case 
# In the `dt5_sex` dataset, countries with single/both sex always have total
c_case <- dt5_sex[Measure=="Cases" & Sex == "Both", unique(Country_new)]
c_death <- dt5_sex[Measure=="Deaths" & Sex == "Both", unique(Country_new)]
c_case_sex<- dt5_sex[Measure=="Cases" & Sex != "Both", unique(Country_new)]
c_death_sex <- dt5_sex[Measure=="Deaths" & Sex != "Both", unique(Country_new)]

map_case <- plot_ava_map(highlight_cnames = c_case)
map_death <- plot_ava_map(highlight_cnames = c_death)
map_case_sex <- plot_ava_map(highlight_cnames = c_case_sex)
map_death_sex <- plot_ava_map(highlight_cnames = c_death_sex)

# aggregated plots for all countries ---- 
all_countries <- get_cnames(dt5)
data_total1 <- rbindlist(lapply(all_countries, get_dt_for_total, 
                                data = dt5,
                                target_interval = seq(0, 90, by = 5),
                                get_f_m = FALSE))
data_total2 <- rbindlist(lapply(all_countries, get_dt_for_total, 
                                data = dt5,
                                target_interval = seq(0, 90, by = 5),
                                get_f_m = TRUE))

# a three-panel plot (Case, Death, CFR) for a specific given interval
g1 <- plot_aggregated_total(data_total1, big_plot = TRUE)
g2 <- plot_aggregated_total(data_total2, by_sex = TRUE, big_plot = TRUE)

```

**Purpose**  

Population characteristics are key to understand the prevalence, spread and fatality of COVID-19 across countries. The COVID Age Database (COVerAGE-DB) provides a valuable insight into the age-and sex-specific patterns of the COVID-19 cases and deaths.


**Source of data**

COVerAGE-DB is an open-access database including cumulative counts of confirmed COVID-19 cases, deaths, and tests by age and sex. Original data and sources are provided alongside data and measures in standardized and age-harmonized formats. The data were extracted from reports published by official governmental institutions in a variety of formats. The [project page](https://github.com/timriffe/covid_age) and the [medRxiv paper](https://www.medrxiv.org/content/10.1101/2020.09.18.20197228v2) contain the technical details. 

The database is still in development. Today it includes `r dt5_ori[, uniqueN(Country)]` countries and `r dt5_ori[Region!="All", uniqueN(Region)]` subnational areas.


**Limitation**  

A limitation of the COVerAGE-DB is the heterogeneous quality of the underlying data, which is difficult to evaluate. Case and death counts are likely underestimated, with underestimation expected to vary by age. As the practices and definitions to count COVID-19 cases and deaths vary by each country, the data should be interpreted with caution when making comparisons across populations or within populations over time. 

### Cases and deaths by age

Figure 1. The `r length(c_case)` countries with national data on counts of COVID-19 cases.

```{r, fig.width=8, fig.height=3.5}
map_case
```

Figure 2. The `r length(c_death)` countries with national data on counts of COVID-19 deaths.

```{r, fig.width=8, fig.height=3.5}
map_death
```

Table 1. The total cases and deaths reported by Johns Hopkins University (JHU) and COVerAGE-DB and COVerAGE-DB's relative share compared to the JHU numbers. The harmonized data for the age groups 0-4, 5-9, 10-14, 15-19 are shown in the table. Their counts sum to age group 0-19 and we also show the share of the age group 0-19 in all age groups. 

```{r}
print_table(dt1)
```

Figure 3. The age pyramid by 5-year age interval for COVID-19 total cases, deaths and crude fatality rate (CFR), which is the number of death divided by case for each age group. In order to calculate the CFR, only countries with both cases and deaths data are used.

```{r, fig.width=14, fig.height=6}
g1
```



### MPIDR confirmed cases and deaths by age and sex

Figure 4. The `r length(c_case_sex)` countries with national data on sex-specific counts of COVID-19 cases.

```{r, fig.width=8, fig.height=3.5}
map_case_sex
```

Figure 5. The `r length(c_death_sex)` countries with national data on sex-specific counts of COVID-19 deaths.

```{r, fig.width=8, fig.height=3.5}
map_death_sex
```

Table 2. The sex-specific cases and deaths in the COVerAGE-DB dataset. The harmonized data for the age groups 0-4, 5-9, 10-14, 15-19, 0-19 and its share in the total are shown in the table. 

```{r}
print_table(dt2)
```

Figure 4. The sex-specific age pyramid by 5-year age interval for COVID-19 total cases, deaths and crude fatality rate (CFR)

```{r, fig.width=14, fig.height=6}
g2
```


## Reference  

Riffe, T., Acosta, E., and The COVerAGE-DB team (2020). COVerAGE-DB: A database of COVID-19 cases and deaths by age. medRxiv https://doi.org/10.1101/2020.09.18.20197228

Dong E, Du H, Gardner L. An interactive web-based dashboard to track COVID-19 in real time. Lancet Inf Dis. 20(5):533-534. https://doi.org/10.1016/S1473-3099(20)30120-1
